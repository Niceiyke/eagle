{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block header %}
<div class="flex justify-between items-center">
    <h1 class="text-2xl font-semibold text-gray-900">{{ title }}</h1>
    <a href="{{ admin_path }}/{{ model_name }}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <i class="fas fa-arrow-left mr-2"></i> Back to List
    </a>
</div>
{% endblock %}

{% block content %}
<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <form method="POST" action="{{ admin_path }}/{{ model_name }}{% if item %}/{{ item.id }}/update{% else %}/create{% endif %}" class="space-y-6">
            {% for field in fields %}
            {% if not field.primary_key %}
            <div class="mb-4">
                <label for="{{ field.name }}" class="block text-sm font-medium text-gray-700">
                    {{ field.name|title }}
                    {% if not field.nullable %}<span class="text-red-500">*</span>{% endif %}
                    {% if field.help_text %}
                    <i class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer" 
                       data-tooltip="{{ field.help_text }}"></i>
                    {% endif %}
                </label>
                
                {% set filter = model_info.get_filter_by_name(field.name) %}
                {% if filter %}
                    {% if filter.type == 'text' %}
                        <input type="text" name="{{ field.name }}" id="{{ field.name }}" 
                               value="{{ item[field.name] if item else '' }}" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               {% if not field.nullable %}required{% endif %}
                               {% if field.max_length %}maxlength="{{ field.max_length }}"{% endif %}
                               {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}>
                    {% elif filter.type == 'number' %}
                        <input type="number" name="{{ field.name }}" id="{{ field.name }}" 
                               value="{{ item[field.name] if item else '' }}" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               {% if not field.nullable %}required{% endif %}
                               {% if field.min_value %}min="{{ field.min_value }}"{% endif %}
                               {% if field.max_value %}max="{{ field.max_value }}"{% endif %}
                               {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}>
                    {% elif filter.type == 'date' %}
                        <input type="date" name="{{ field.name }}" id="{{ field.name }}" 
                               value="{{ item[field.name].strftime('%Y-%m-%d') if item and item[field.name] else '' }}" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               {% if not field.nullable %}required{% endif %}>
                    {% elif filter.type == 'boolean' %}
                        <div class="mt-2">
                            <input type="checkbox" name="{{ field.name }}" id="{{ field.name }}" 
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                   {% if item and item[field.name] %}checked{% endif %}>
                        </div>
                    {% elif filter.type == 'select' %}
                        {% if field.is_relationship %}
                            {% if field.uselist %}
                                <!-- Many-to-many relationship -->
                                <select name="{{ field.name }}" id="{{ field.name }}" 
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                        multiple
                                        {% if not field.nullable %}required{% endif %}>
                                    {% for option in filter.options %}
                                        {% set is_selected = false %}
                                        {% if item and item[field.name] %}
                                            {% for rel_item in item[field.name] %}
                                                {% if option.value == rel_item.id|string %}
                                                    {% set is_selected = true %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        <option value="{{ option.value }}" {% if is_selected %}selected{% endif %}>
                                            {{ option.display }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <p class="mt-1 text-xs text-gray-500">Hold Ctrl/Cmd to select multiple options</p>
                            {% else %}
                                <!-- Many-to-one relationship -->
                                <select name="{{ field.name }}" id="{{ field.name }}" 
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                        {% if not field.nullable %}required{% endif %}>
                                    {% if field.nullable %}
                                        <option value="">-- Select {{ field.name|title }} --</option>
                                    {% endif %}
                                    {% for option in filter.options %}
                                        <option value="{{ option.value }}" 
                                                {% if item and item[field.name] and option.value == item[field.name].id|string %}selected{% endif %}>
                                            {{ option.display }}
                                        </option>
                                    {% endfor %}
                                </select>
                            {% endif %}
                        {% else %}
                            <!-- Regular select field -->
                            <select name="{{ field.name }}" id="{{ field.name }}" 
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    {% if not field.nullable %}required{% endif %}>
                                {% if field.nullable %}
                                    <option value="">-- Select {{ field.name|title }} --</option>
                                {% endif %}
                                {% for option in filter.options %}
                                    <option value="{{ option.value }}" 
                                            {% if item and item[field.name] and option.value == item[field.name]|string %}selected{% endif %}>
                                        {{ option.display }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    {% else %}
                        <input type="text" name="{{ field.name }}" id="{{ field.name }}" 
                               value="{{ item[field.name] if item else '' }}" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               {% if not field.nullable %}required{% endif %}
                               {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}>
                    {% endif %}
                {% else %}
                    <input type="text" name="{{ field.name }}" id="{{ field.name }}" 
                           value="{{ item[field.name] if item else '' }}" 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                           {% if not field.nullable %}required{% endif %}
                           {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}>
                {% endif %}
                
                {% if field.error %}
                <p class="mt-1 text-sm text-red-600">{{ field.error }}</p>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            
            <div class="flex justify-end space-x-3 pt-4">
                <a href="{{ admin_path }}/{{ model_name }}" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancel
                </a>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-save mr-2"></i> Save
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Handle form submission for checkboxes and multi-selects
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            // Convert checkbox values to proper boolean values
            this.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked) {
                    // Only add the checkbox to the form data if it's not checked
                    // This ensures the server knows to set the value to false
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = checkbox.name;
                    hiddenInput.value = 'off';
                    checkbox.parentNode.insertBefore(hiddenInput, checkbox);
                }
            });

            // Handle multi-select fields (many-to-many relationships)
            this.querySelectorAll('select[multiple]').forEach(select => {
                // Convert selected options to a comma-separated string
                const selected = Array.from(select.selectedOptions).map(option => option.value);
                
                // Remove the original select from the form
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = select.name;
                hiddenInput.value = selected.join(',');
                
                select.parentNode.insertBefore(hiddenInput, select);
                select.name = ''; // Remove the original select from form data
            });
        });
    });

    // Tooltip functionality for help text
    document.querySelectorAll('[data-tooltip]').forEach(el => {
        el.addEventListener('mouseenter', function() {
            const tooltip = document.createElement('div');
            tooltip.className = 'absolute bg-gray-800 text-white px-2 py-1 rounded text-sm z-50';
            tooltip.textContent = this.getAttribute('data-tooltip');
            this.appendChild(tooltip);
        });

        el.addEventListener('mouseleave', function() {
            const tooltip = this.querySelector('div');
            if (tooltip) tooltip.remove();
        });
    });

    // Initialize Select2 for better select controls (if available)
    if (typeof $ !== 'undefined' && $.fn.select2) {
        $('select[multiple]').select2({
            width: '100%',
            placeholder: 'Select options',
            allowClear: true
        });
    }

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
</script>
{% endblock %}
