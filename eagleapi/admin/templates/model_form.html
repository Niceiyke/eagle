{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block header %}
<div class="flex justify-between items-center">
    <h1 class="text-2xl font-semibold text-gray-900">{{ title }}</h1>
    <a href="{{ admin_path }}/{{ model_name }}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <i class="fas fa-arrow-left mr-2"></i> Back to List
    </a>
</div>
{% endblock %}

{% block content %}
<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <form method="POST" action="{{ admin_path }}/{{ model_name }}{% if item %}/{{ item.id }}/update{% else %}/create{% endif %}" class="space-y-6">
            {% for field in fields %}
            {% if not field.primary_key %}
            <div class="mb-4">
                <label for="{{ field.name }}" class="block text-sm font-medium text-gray-700">
                    {{ field.name|title }}
                    {% if not field.nullable %}<span class="text-red-500">*</span>{% endif %}
                    {% if field.help_text %}
                    <i class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer" 
                       data-tooltip="{{ field.help_text }}"></i>
                    {% endif %}
                </label>
                
                {% set filter = model_info.get_filter_by_name(field.name) %}
                {% if filter %}
                    {% if filter.type == 'text' %}
                        <input type="text" name="{{ field.name }}" id="{{ field.name }}" 
                               value="{{ item[field.name] if item else '' }}" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               {% if not field.nullable %}required{% endif %}
                               {% if field.max_length %}maxlength="{{ field.max_length }}"{% endif %}
                               {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}>
                    {% elif filter.type == 'number' %}
                        <input type="number" name="{{ field.name }}" id="{{ field.name }}" 
                               value="{{ item[field.name] if item else '' }}" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               {% if not field.nullable %}required{% endif %}
                               {% if field.min_value %}min="{{ field.min_value }}"{% endif %}
                               {% if field.max_value %}max="{{ field.max_value }}"{% endif %}
                               {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}>
                    {% elif filter.type == 'date' %}
                        <input type="date" name="{{ field.name }}" id="{{ field.name }}" 
                               value="{{ item[field.name].strftime('%Y-%m-%d') if item and item[field.name] else '' }}" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               {% if not field.nullable %}required{% endif %}>
                    {% elif filter.type == 'boolean' %}
                        <div class="mt-2">
                            <input type="checkbox" name="{{ field.name }}" id="{{ field.name }}" 
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                   {% if item and item[field.name] %}checked{% endif %}>
                        </div>
                    {% elif filter.type == 'select' %}
                        <select name="{{ field.name }}" id="{{ field.name }}" 
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                {% if not field.nullable %}required{% endif %}>
                            {% if not field.nullable %}
                                <option value="">Select {{ field.name|title }}</option>
                            {% endif %}
                            {% for option in filter.options %}
                                <option value="{{ option }}" {% if item and str(item[field.name]) == option %}selected{% endif %}>
                                    {{ option }}
                                </option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <input type="text" name="{{ field.name }}" id="{{ field.name }}" 
                               value="{{ item[field.name] if item else '' }}" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               {% if not field.nullable %}required{% endif %}
                               {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}>
                    {% endif %}
                {% else %}
                    <input type="text" name="{{ field.name }}" id="{{ field.name }}" 
                           value="{{ item[field.name] if item else '' }}" 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                           {% if not field.nullable %}required{% endif %}
                           {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}>
                {% endif %}
                
                {% if field.error %}
                <p class="mt-1 text-sm text-red-600">{{ field.error }}</p>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            
            <div class="flex justify-end space-x-3 pt-4">
                <a href="{{ admin_path }}/{{ model_name }}" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancel
                </a>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-save mr-2"></i> Save
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Convert checkbox values to proper boolean values
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            this.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.hasAttribute('checked') && !checkbox.checked) {
                    checkbox.value = 'off';
                }
            });
        });
    });

    // Tooltip functionality for help text
    document.querySelectorAll('[data-tooltip]').forEach(el => {
        el.addEventListener('mouseenter', function() {
            const tooltip = document.createElement('div');
            tooltip.className = 'absolute bg-gray-800 text-white px-2 py-1 rounded text-sm z-50';
            tooltip.textContent = this.getAttribute('data-tooltip');
            this.appendChild(tooltip);
        });

        el.addEventListener('mouseleave', function() {
            const tooltip = this.querySelector('div');
            if (tooltip) tooltip.remove();
        });
    });

    // JSON field validation
    document.querySelectorAll('textarea[data-type="json"]').forEach(textarea => {
        textarea.addEventListener('input', function() {
            try {
                JSON.parse(this.value);
                this.classList.remove('border-red-500');
                this.classList.add('border-green-500');
            } catch (e) {
                this.classList.remove('border-green-500');
                this.classList.add('border-red-500');
            }
        });
    });
</script>
{% endblock %}
